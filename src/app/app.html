<div class="main-layout">
  <app-navbar (cityFound)="maFonctionDePlanification($event)"></app-navbar>

  <div class="map-wrapper">
    <app-world-map (destinationSelected)="maFonctionDePlanification($event)"></app-world-map>

    <div class="info-overlay">
      @if (loading) {
        <div class="destination-card">
          <div class="spinner-border text-primary spinner-border-sm me-2" role="status"></div>
          <p class="loader-text">Analyse de {{ cityName }} par l'IA... <i class="bi bi-cpu"></i></p>
        </div>
      }

      @if (cityName && !loading) {
        <div class="destination-card">
          <button class="btn-close" (click)="fermerFenetre()" title="Fermer"></button>

          @if (cityImage) {
            <div class="city-header-image">
              <img [src]="cityImage" alt="Destination">
              <div class="image-shadow"></div>
            </div>
          }

          <div class="card-content">
            <h1>{{ cityName }}</h1>

            @if (weatherData) {
              <div class="weather-badge d-flex align-items-center p-3 rounded-4 bg-dark bg-opacity-75 text-white shadow-sm border border-secondary border-opacity-25">

                <img [src]="'https://openweathermap.org/img/wn/' + weatherData.weather[0].icon + '@2x.png'"
                     alt="météo" style="width: 50px;" class="filter-drop-shadow">

                <div class="weather-info ms-3">
                  <div class="d-flex align-items-baseline">
                    <span class="temp fw-bold fs-3 text-white">{{ weatherData.main.temp }}°C</span>
                    <span class="desc text-capitalize ms-3 fst-italic border-start border-secondary ps-3 text-white-50">
          {{ weatherData.weather[0].description }}
        </span>
                  </div>
                </div>
              </div>

              <div class="conseil-ia p-3 rounded-4 mt-2 border-0 shadow-sm d-flex align-items-start"
                   style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(5px);">
                <i class="bi bi-lightbulb-fill text-warning me-2 mt-1"></i>
                <em class="small text-white opacity-75">{{ conseilMeteo }}</em>
              </div>
            }

            @if (!itinerary) {
              <div class="button-group mt-3">
                <button class="btn-generate" (click)="genererItineraryIA()">
                  <i class="bi bi-stars me-2"></i>Découvrir la ville
                </button>
                <button class="btn-secondary" (click)="fermerFenetre()">
                  <i class="bi bi-geo-alt me-2"></i>Changer de lieu
                </button>
              </div>
            }

            @else {
              <div class="resultat-ia-interne" id="pdf-content">
                @if (specialites.length > 0) {
                  <div class="gastro-wrapper">
                    <div class="gastro-header">
                      <span class="gastro-subtitle text-primary fw-bold">Culture & Gastronomie</span>
                      <h3 class="gastro-main-title">Spécialités locales</h3>
                    </div>

                    <div class="gastro-grid">
                      @for (s of specialites; track s.nom) {
                        <div class="gastro-card">
                          <div class="gastro-card-content">
                            <div class="gastro-top">
                              <span class="gastro-tag">Saveur</span>
                              <span class="gastro-icon"><i class="bi bi-egg-fried text-warning"></i></span>
                            </div>
                            <h4>{{ s.nom }}</h4>
                            <p>{{ s.desc }}</p>
                          </div>
                        </div>
                      }
                    </div>
                  </div>
                }

                <div class="itinerary-content mt-4">
                  <h5 class="fw-bold"><i class="bi bi-journal-text me-2"></i>Programme suggéré</h5>
                  <p style="white-space: pre-wrap;" [innerHTML]="formatText(itinerary)" class="small"></p>
                </div>
              </div>

              <div class="pdf-section p-3 bg-light rounded shadow-sm">
                <div class="input-group mb-2">
                  <span class="input-group-text bg-white border-0"><i class="bi bi-calendar3"></i></span>
                  <input type="number" [(ngModel)]="nbJours" min="1" max="30" class="form-control border-0 shadow-none">
                  <span class="input-group-text bg-white border-0">jours</span>
                </div>

                <button class="btn-pdf w-100" [disabled]="isGeneratingPDF" (click)="preparerEtTelechargerPDF()">
                  <i class="bi bi-file-earmark-pdf-fill me-2"></i>{{ isGeneratingPDF ? 'Rédaction...' : 'Télécharger le carnet' }}
                </button>
              </div>

              <div class="flight-section mt-3">
                <div class="input-group border rounded shadow-sm overflow-hidden">
                  <span class="input-group-text bg-white border-0"><i class="bi bi-airplane"></i></span>
                  <input
                    type="text"
                    class="form-control border-0 shadow-none"
                    [(ngModel)]="villeDepart"
                    (input)="chercherAeroport($event)"
                    placeholder="Ville de départ..."
                  />
                  <button (click)="ouvrirLienVols()" [disabled]="!villeDepart" class="btn btn-primary px-3 border-0">
                    <i class="bi bi-search"></i>
                  </button>
                </div>

                @if (suggestionsDepart.length > 0) {
                  <ul class="list-group mt-1 shadow-sm border-0 position-absolute w-100" style="z-index: 10;">
                    @for (sug of suggestionsDepart; track sug) {
                      <li (click)="selectionnerDepart(sug)" class="list-group-item list-group-item-action py-2">
                        <i class="bi bi-geo-alt-fill text-muted me-2"></i><strong>{{ sug.name }}</strong> <small>({{ sug.country }})</small>
                      </li>
                    }
                  </ul>
                }
              </div>

              <div class="button-group mt-4 d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary w-50" (click)="fermerFenetre()">
                  <i class="bi bi-arrow-left"></i> Autre
                </button>
                <button class="btn btn-sm btn-outline-danger w-50" (click)="reinitialiserTout()">
                  <i class="bi bi-globe"></i> Reset
                </button>
              </div>
            }
          </div>
        </div>
      }
    </div>
  </div>
</div>
